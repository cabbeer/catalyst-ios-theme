<html>
<head><title>newclock</title><base href="Private/"/></head>
<style> 
#Layer{width: 322px; height: 482px; position: absolute; top: -1px; right: 0px; down: 0px; left: -1px;} 
.stretch {width:100%; height:100%;} 
</style>
<div id="Layer"> <!-- ><img src="/private/var/mobile/Library/SpringBoard/HomeBackground.jpg" class="stretch"/>--></div>

<style>


    SPAN#clock
{
	font-family: Helvetica;
	font-weight: bold; 
	color: #d1d1d1; 
	text-shadow: 0px -1px 0px rgba(0, 0, 0, 0.7);	
	/*text-shadow: #FFFFFF 0px 1px 0px;*/
	font-size: 24px;
	

}

    SPAN#ampm
{
	font-family: Helvetica;
	font-weight: bold; 
	color: #d1d1d1; 
	text-shadow: 0px -1px 0px rgba(0, 0, 0, 0.7);	
	/*text-shadow: #FFFFFF 0px 1px 0px;*/
	font-size: 13px;

}

    TD#date 
{
	font-family: Helvetica;
	font-weight: bold; 
	text-align: left;
	color: #d1d1d1; 
	text-shadow: 0px -1px 0px rgba(0, 0, 0, 0.7);	
	/*text-shadow: #FFFFFF 0px 1px 0px;*/
	font-size: 13px;
/*	text-transform: uppercase;*/

}
	
</style>

<script type="text/javascript">
<!--
var this_weekday_name_array = new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")
var this_month_name_array = new Array("JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER")	//predefine month names
    

var this_date_timestamp = new Date()	

var this_weekday = this_date_timestamp.getDay()    
var this_date = this_date_timestamp.getDate()	 
var this_month = this_date_timestamp.getMonth()    
var this_year = this_date_timestamp.getYear()	 

if (this_year < 1000)
    this_year+= 1900;
if (this_year==101)
    this_year=2001;	   

var this_date_string = this_weekday_name_array[this_weekday] + " " + this_date + " " + this_month_name_array[this_month]//concat long date string

// -->
function init ( )
{
  timeDisplay = document.createTextNode ( "" );
  document.getElementById("clock").appendChild ( timeDisplay );
}

function updateClock ( )
{
  var currentTime = new Date ( );

  var currentHours = currentTime.getHours ( );
  var currentMinutes = currentTime.getMinutes ( );
  var currentSeconds = currentTime.getSeconds ( );

  // Pad the minutes and seconds with leading zeros, if required
  currentMinutes = ( currentMinutes < 10 ? "0" : "" ) + currentMinutes;
  currentSeconds = ( currentSeconds < 10 ? "0" : "" ) + currentSeconds;

  // Choose either "AM" or "PM" as appropriate
  var timeOfDay = ( currentHours < 12 ) ? "AM" : "PM";

  // Convert the hours component to 12-hour format if needed
  currentHours = ( currentHours > 12 ) ? currentHours - 12 : currentHours;

  // Convert an hours component of "0" to "12"
  currentHours = ( currentHours == 0 ) ? 12 : currentHours;

  // Compose the string for display
  var currentTimeString = currentHours + ":" + currentMinutes;

  // Update the time display
  document.getElementById("clock").firstChild.nodeValue = currentTimeString;
}

function init2 ( )
{
  timeDisplay = document.createTextNode ( "" );
  document.getElementById("ampm").appendChild ( timeDisplay );
}

function amPm ( )
{
  var currentTime = new Date ( );

  var currentHours = currentTime.getHours ( );

  // Choose either "AM" or "PM" as appropriate
  var timeOfDay = ( currentHours < 12 ) ? "AM" : "PM";

  // Convert the hours component to 12-hour format if needed
  currentHours = ( currentHours > 12 ) ? currentHours - 12 : currentHours;

  // Convert an hours component of "0" to "12"
  currentHours = ( currentHours == 0 ) ? 12 : currentHours;

  // Compose the string for display
  var currentTimeString = timeOfDay;

  // Update the time display
  document.getElementById("ampm").firstChild.nodeValue = currentTimeString;
}

function init3 ( )
{
  timeDisplay = document.createTextNode ( "" );
  document.getElementById("calendar").appendChild ( timeDisplay );
}

function calendarDate ( )
{
  var this_weekday_name_array = new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")
  var this_month_name_array = new Array("JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER")	  //predefine month names
    
  var this_date_timestamp = new Date()	  

  var this_weekday = this_date_timestamp.getDay()    
  var this_date = this_date_timestamp.getDate()    
  var this_month = this_date_timestamp.getMonth()    

//document.getElementById("calendar").firstChild.nodeValue = this_weekday_name_array[this_weekday] + " " + this_date + " " + this_month_name_array[this_month]//concat long date string
  
document.getElementById("calendar").firstChild.nodeValue = this_month_name_array[this_month] + " " + this_year	//concat long date string
}

// -->
</script>

</head>


<body >






<table style="position: absolute; top: 300px; left: 21px; width: 180px; height: 461px;" cellspacing="0" cellpadding="0" align="LEFT">
<tr align="LEFT" valign="top"  border="0" cellpadding="0">
    <td height="12" valign="top" margin-left="20" >
    <span id="clock">
	<script language="JavaScript">updateClock(); setInterval('updateClock()', 1000 )</script></span><span id="ampm">
	<script language="JavaScript">amPm(); setInterval('amPm()', 1000 )</script>
    </span>
    </td>
</tr>
<tr>
    <td id="date" valign="top">
	<span id="calendar">
	<script language="JavaScript">calendarDate(); setInterval('calendarDate()', 1000 )</script>
	</span>
    </td>
</tr>
</table>

</body>
<html>

<head><title>weather</title></head>



<head>

    <base href="Private/"/>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

</head>



</script>
	<script type="text/javascript">

var locale = "07043" /*ITXX0042=Milan/UKXX0085=London/USNY0996=NYC/NLXX0016=The Hague/USCA0638=LA/USNV0049=Vegas/USCA0987=Frisco/FRXX0023=Cannes*/

var isCelsius = false

var useRealFeel = false

var enableWallpaper = true;
var enableLockScreen = true;

var stylesheetWall = 'mini'
var stylesheetLock = 'mini'
var stylesheet = 'mini'

var iconSetWall = 'stardock'
var iconExtWall = ".png"
var iconSetLock = 'stardock'
var iconExtLock = '.png'

var source = 'yahooWeather'

var updateInterval = 15



var postal;
var demoMode = false;
var enabled;

if (location.href.indexOf("LockBackground")  == -1){
	stylesheet = stylesheetWall;
	iconSet = iconSetWall;
	iconExt = iconExtWall;
	enabled = enableWallpaper;
}else{
	stylesheet = stylesheetLock;
	iconSet = iconSetLock;
	iconExt = iconExtLock;
	enabled = enableLockScreen;
}

if(enabled == true){
if(iconSet == null || iconSet == 'null' || iconSet == ""){
	var iconSet = stylesheet;
}

var headID = document.getElementsByTagName("head")[0];	       
var styleNode = document.createElement('link');
styleNode.type = 'text/css';
styleNode.rel = 'stylesheet';
styleNode.href = 'Stylesheets/'+stylesheet+'.css';
headID.appendChild(styleNode);

var scriptNode = document.createElement('script');
scriptNode.type = 'text/javascript';
scriptNode.src = 'Sources/'+source+'.js';
headID.appendChild(scriptNode);
}

function onLoad(){
	if (enabled == true){ 
	if (demoMode == true){
		document.getElementById("weatherIcon").src="Icon Sets/"+iconSet+"/"+"cloudy1"+iconExt;
		document.getElementById("city").innerText="Somewhere";
		document.getElementById("desc").innerText="Partly Cloudy";
		document.getElementById("temp").innerText="100ยบ";
		
	}else{ 
	document.getElementById("weatherIcon").src="Icon Sets/"+iconSet+"/"+"dunno"+iconExt;
	validateWeatherLocation(escape(locale).replace(/^%u/g, "%"), setPostal)
	}
	}else{
		document.getElementsByTagName("body")[0].innerText='';
	}
}

function convertTemp(num)
{
	if (isCelsius == true)
		return Math.round ((num - 32) * 5 / 9);
	else
		return num;
}

function setPostal(obj){
	
	if (obj.error == false){
		if(obj.cities.length > 0){
			postal = escape(obj.cities[0].zip).replace(/^%u/g, "%")
			document.getElementById("WeatherContainer").className = "";	
			weatherRefresherTemp();
		}else{
			document.getElementById("city").innerText="Not Found";
			document.getElementById("WeatherContainer").className = "errorLocaleNotFound";	
		}
	}else{
		document.getElementById("city").innerText=obj.errorString;
		document.getElementById("WeatherContainer").className = "errorLocaleValidate";	
		setTimeout('validateWeatherLocation(escape(locale).replace(/^%u/g, "%"), setPostal)', Math.round(1000*60*5));
	}
}

function dealWithWeather(obj){

	if (obj.error == false){
		document.getElementById("city").innerText=obj.city;
		document.getElementById("desc").innerText=obj.description.toLowerCase();
		
		if(useRealFeel == true){
			tempValue = convertTemp(obj.realFeel);
		}else{
			tempValue = convertTemp(obj.temp)
		}
		document.getElementById("temp").innerHTML=tempValue+ "&#176;";
		document.getElementById("weatherIcon").src="Icon Sets/"+iconSet+"/"+MiniIcons[obj.icon]+iconExt;
		document.getElementById("WeatherContainer").className = "";	

		
	}else{
		//Could be down to any number of things, which is unhelpful...
		document.getElementById("WeatherContainer").className = "errorWeatherDataFetch";	
	}
	
	
}

function weatherRefresherTemp(){
	fetchWeatherData(dealWithWeather,postal);
	setTimeout(weatherRefresherTemp, 60*1000*updateInterval);
}

var MiniIcons =
[
	"0",		       //0	tornado
	"1",		       //1	tropical storm
	"2",		       //2	hurricane
	"3",		       //3	severe thunderstorms
	"4",		       //4	thunderstorms
	"5",		       //5	mixed rain and snow
	"6",		       //6	mixed rain and sleet
	"7",		       //7	mixed snow and sleet
	"8",		       //8	freezing drizzle
	"9",		       //9	drizzle
	"10",		       //10	freezing rain
	"11",		       //11	showers
	"12",		       //12	showers
	"13",		       //13	snow flurries
	"14",		       //14	light snow showers
	"15",		       //15	blowing snow
	"16",		       //16	snow
	"17",		       //17	hail
	"17",		       //18	sleet
	"19",		       //19	dust
	"20",		       //20	foggy
	"21",		       //21	haze
	"22",		       //22	smoky
	"23",		       //23	blustery
	"24",		       //24	windy
	"25",		       //25	cold
	"26",		       //26	cloudy
	"27",		      //27	mostly cloudy (night)
	"28",		       //28	mostly cloudy (day)
	"29",		      //29	partly cloudy (night)
	"30",		       //30	partly cloudy (day)
	"31",		      //31	clear (night)
	"32",		       //32	sunny
	"33",		       //33	fair (night)
	"34",		       //34	fair (day)
	"35",		       //35	mixed rain and hail
	"36",		       //36	hot
	"37",		       //37	isolated thunderstorms
	"38",		       //38	scattered thunderstorms
	"39",		       //39	scattered thunderstorms
	"40",		       //40	scattered showers
	"41",		       //41	heavy snow
	"42",		       //42	scattered snow showers
	"43",		       //43	heavy snow
	"44",		       //44	partly cloudy
	"45",		       //45	thundershowers
	"46",		       //46	snow showers
	"47",		       //47	isolated thundershowers
	"dunno",		//3200 not available
]

function constructError (string)
{
	return {error:true, errorString:string};
}

function findChild (element, nodeName)
{
	var child;
	
	for (child = element.firstChild; child != null; child = child.nextSibling)
	{
		if (child.nodeName == nodeName)
			return child;
	}
	
	return null;
}


function fetchWeatherData (callback, zip)
{
	url="http://weather.yahooapis.com/forecastrss?u=f&p=" //u=Farenheit, because accuWeather sucks
	
	var xml_request = new XMLHttpRequest();
	xml_request.onload = function(e) {xml_loaded(e, xml_request, callback);}
	xml_request.overrideMimeType("text/xml");
	xml_request.open("GET", url+zip);
	xml_request.setRequestHeader("Cache-Control", "no-cache");
	xml_request.send(null); 
	
	return xml_request;
}

function xml_loaded (event, request, callback)
{
	if (request.responseXML)
	{
		var obj = {error:false, errorString:null};
		var effectiveRoot = findChild(findChild(request.responseXML, "rss"), "channel");
		obj.city = findChild(effectiveRoot, "yweather:location").getAttribute("city");
		obj.realFeel = findChild(effectiveRoot, "yweather:wind").getAttribute("chill");//Only accounts for windChill
		
		conditionTag = findChild(findChild(effectiveRoot, "item"), "yweather:condition");
		obj.temp = conditionTag.getAttribute("temp");
		obj.icon = conditionTag.getAttribute("code");
		obj.description = conditionTag.getAttribute("text"); 
		callback (obj); 
	}else{
		callback ({error:true, errorString:"XML request failed. no responseXML"});
	}
}


function validateWeatherLocation (location, callback)
{
	var obj = {error:false, errorString:null, cities: new Array};
	obj.cities[0] = {zip: location}; //Not very clever, are we?
	callback (obj);
}

</script>

<body bgcolor="Transparent" onload="onLoad()">

<div id="WeatherContainer"> <div id="TextContainer"> <p id="city">...</p> <p id="temp">&#176;</p> <p id="desc">...</p> </div>

<img id="weatherIcon" src=""/> </div>
</body></html>
